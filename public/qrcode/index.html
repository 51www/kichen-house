<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>äºŒç»´ç è¯†åˆ«ä¸åŒæ­¥</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      --primary: #3b82f6;
      --surface: rgba(255, 255, 255, 0.8);
      --dark-text: #0f172a;
      --border: rgba(15, 23, 42, 0.1);
      --success: #22c55e;
      --warning: #f97316;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #eef2ff 0%, #e2e8f0 45%, #cbd5f5 100%);
      color: var(--dark-text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    main {
      width: min(960px, 100%);
      background: var(--surface);
      border-radius: 24px;
      box-shadow: 0 25px 60px rgba(15, 23, 42, 0.15);
      backdrop-filter: blur(16px);
      padding: 32px;
      display: grid;
      gap: 24px;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.75rem, 2.5vw, 2.5rem);
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    p.lead {
      margin: 4px 0 0;
      color: rgba(15, 23, 42, 0.7);
      font-size: 1rem;
    }

    .panels {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
    }

    .card {
      background: white;
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
      overflow: hidden;
    }

    .video-shell {
      position: relative;
      width: 100%;
      aspect-ratio: 3 / 4;
      border-radius: 16px;
      overflow: hidden;
      background: #0f172a;
      border: 1px solid rgba(15, 23, 42, 0.15);
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-overlay {
      position: absolute;
      inset: 0;
      border: 2px dashed rgba(255, 255, 255, 0.6);
      border-radius: 16px;
      pointer-events: none;
    }

    button.primary {
      border: none;
      border-radius: 999px;
      padding: 12px 22px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      color: white;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button.primary:active {
      transform: scale(0.97);
    }

    .result-box {
      min-height: 120px;
      border-radius: 16px;
      border: 1px dashed rgba(15, 23, 42, 0.2);
      padding: 18px;
      background: rgba(59, 130, 246, 0.05);
      word-break: break-all;
      font-size: 1.05rem;
      line-height: 1.5;
      transition: border-color 0.2s ease, background 0.2s ease;
    }

    .result-box[data-state='filled'] {
      border-color: rgba(34, 197, 94, 0.5);
      background: rgba(34, 197, 94, 0.08);
    }

    .result-box.remote-update {
      animation: pulse-glow 0.7s ease;
    }

    @keyframes pulse-glow {
      0% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.45);
      }
      100% {
        box-shadow: 0 0 0 18px rgba(59, 130, 246, 0);
      }
    }

    .actions {


      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    button.secondary {
      border: 1px solid rgba(15, 23, 42, 0.2);
      border-radius: 14px;
      padding: 10px 18px;
      background: white;
      color: var(--dark-text);
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button.secondary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button.secondary.copied {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 10px 20px rgba(34, 197, 94, 0.35);
    }

    .status {

      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
      color: rgba(15, 23, 42, 0.7);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--warning);
    }

    footer {
      font-size: 0.9rem;
      color: rgba(15, 23, 42, 0.6);
      text-align: center;
    }

    @media (max-width: 640px) {
      body {
        padding: 16px;
      }

      main {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>äºŒç»´ç å³æ—¶è¯†åˆ«</h1>
      <p class="lead">åœ¨æ‰‹æœºæˆ–ç”µè„‘ç«¯è¯†åˆ«äºŒç»´ç ï¼Œå®æ—¶åŒæ­¥åˆ°æ‰€æœ‰æ‰“å¼€çš„é¡µé¢ã€‚</p>
    </header>

    <section class="panels">
      <article class="card">
        <h2>æ‰«ç è¯†åˆ«</h2>
        <div class="video-shell">
          <video id="preview" muted playsinline></video>
          <span class="video-overlay"></span>
        </div>
        <button id="scanButton" class="primary" disabled>åŠ è½½ä¸­...</button>
        <div class="status">
          <span class="status-dot" id="cameraStatus"></span>
          <span id="cameraStatusText">æ‘„åƒå¤´å¾…å‘½</span>
        </div>
      </article>

      <article class="card">
        <h2>è¯†åˆ«ç»“æœ</h2>
        <div id="resultBox" class="result-box">æš‚æœªè¯†åˆ«å†…å®¹</div>
        <div class="actions">
          <button id="copyButton" class="secondary" disabled>å¤åˆ¶ç»“æœ</button>
        </div>
        <div class="status">
          <span class="status-dot" id="syncStatusDot"></span>
          <span id="syncStatusText">åŒæ­¥è¿æ¥åˆå§‹åŒ–ä¸­</span>
        </div>
      </article>
    </section>

    <footer>è¯·ç¡®ä¿æˆäºˆæ‘„åƒå¤´æƒé™ï¼Œå¹¶ä¿æŒç½‘ç»œç•…é€šä»¥è·å¾—æœ€ä½³ä½“éªŒã€‚</footer>
  </main>

  <script>
    // åŠ¨æ€åŠ è½½è„šæœ¬ï¼Œæ”¯æŒå¤šCDNå¤‡ç”¨è‡ªåŠ¨é‡è¯•
    function loadScript(urls, name) {
      return new Promise((resolve, reject) => {
        let index = 0;
        
        function tryLoad() {
          if (index >= urls.length) {
            reject(new Error(`${name} æ‰€æœ‰CDNæºå‡åŠ è½½å¤±è´¥`));
            return;
          }
          
          const script = document.createElement('script');
          script.src = urls[index];
          script.onload = () => {
            console.log(`${name} ä» ${urls[index]} åŠ è½½æˆåŠŸ`);
            resolve();
          };
          script.onerror = () => {
            console.warn(`${name} ä» ${urls[index]} åŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æº...`);
            index++;
            tryLoad();
          };
          document.head.appendChild(script);
        }
        
        tryLoad();
      });
    }

    // ZXing å¤šä¸ªå¤‡ç”¨CDNæº
    const zxingCDNs = [
      'zxing.min.js',
    ];

    // PubNub å¤šä¸ªå¤‡ç”¨CDNæº
    const pubnubCDNs = [
      'pubnub.min.js', 
    ];

    // å¹¶è¡ŒåŠ è½½ä¸¤ä¸ªåº“
    Promise.all([
      loadScript(zxingCDNs, 'ZXing'),
      loadScript(pubnubCDNs, 'PubNub')
    ]).then(() => {
      console.log('âœ… æ‰€æœ‰ä¾èµ–åº“åŠ è½½æˆåŠŸï¼Œåˆå§‹åŒ–åº”ç”¨...');
      initApp();
    }).catch(err => {
      console.error('âŒ ä¾èµ–åº“åŠ è½½å¤±è´¥:', err);
      alert('ä¾èµ–åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢\n\n' + err.message);
    });

    function initApp() {
    (function () {
      const scanButton = document.getElementById('scanButton');
      const copyButton = document.getElementById('copyButton');
      const cameraStatusDot = document.getElementById('cameraStatus');
      const cameraStatusText = document.getElementById('cameraStatusText');
      const syncStatusDot = document.getElementById('syncStatusDot');
      const syncStatusText = document.getElementById('syncStatusText');
      const resultBox = document.getElementById('resultBox');

      const statusColorMap = {
        idle: 'var(--warning)',
        pending: '#facc15',
        scanning: 'var(--primary)',
        success: 'var(--success)',
        error: '#ef4444'
      };

      const syncColorMap = {
        connecting: '#facc15',
        online: 'var(--success)',
        error: '#ef4444',
        update: '#38bdf8'
      };

      const CHANNEL_NAME = 'sc-business-qrcode-sync-channel';
      
      // è°ƒè¯•ï¼šæ£€æŸ¥ ZXing åŠ è½½æƒ…å†µ
      console.log('ğŸ” æ£€æŸ¥ window ä¸Šçš„ ZXing ç›¸å…³å¯¹è±¡:');
      console.log('window.ZXingBrowser:', window.ZXingBrowser);
      console.log('window.ZXing:', window.ZXing);
      console.log('window ä¸Šæ‰€æœ‰åŒ…å« ZXing çš„å±æ€§:', Object.keys(window).filter(k => k.includes('ZXing')));
      
      // å°è¯•å¤šç§å¯èƒ½çš„å¯¼å‡ºåç§°
      const ZXing = window.ZXingBrowser || window.ZXing || window;

      if (!ZXing.BrowserQRCodeReader) {
        scanButton.disabled = true;
        const msg = 'ZXing åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢';
        setCameraStatus('error', msg);
        console.error('âŒ ZXing.BrowserQRCodeReader ä¸å­˜åœ¨');
        console.error('å¯ç”¨çš„å¯¹è±¡:', ZXing);
        alert(msg + '\n\nè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…');
        return;
      }
      
      console.log('âœ… ZXing åº“å·²å°±ç»ª');
      scanButton.disabled = false;
      scanButton.textContent = 'å¼€å§‹è¯†åˆ«';

      const codeReader = new ZXing.BrowserQRCodeReader();
      let activeControls = null;
      let isScanning = false;
      let lastResult = '';
      let copyResetTimer = null;
      const pubnubClient = initRealtimeSync();

      scanButton.addEventListener('click', () => {
        console.log('ğŸ”˜ å¼€å§‹è¯†åˆ«æŒ‰é’®è¢«ç‚¹å‡»');
        if (isScanning) {
          stopScanning(true);
          return;
        }
        startScanning();
      });

      copyButton.addEventListener('click', handleCopyResult);

      function setCameraStatus(state, text) {
        cameraStatusDot.style.background = statusColorMap[state] || statusColorMap.idle;
        cameraStatusText.textContent = text;
      }

      function setSyncStatus(state, text) {
        syncStatusDot.style.background = syncColorMap[state] || syncColorMap.connecting;
        syncStatusText.textContent = text;
      }

      async function startScanning() {
        console.log('ğŸ“· å¼€å§‹æ‰«ææµç¨‹');
        
        // if (!navigator.mediaDevices) {
        //   const msg = 'å½“å‰ç¯å¢ƒä¸æ”¯æŒæ‘„åƒå¤´è°ƒç”¨\n\nè¯·ä½¿ç”¨ HTTPS æˆ– localhost è®¿é—®';
        //   setCameraStatus('error', msg);
        //   alert(msg);
        //   console.error('âŒ navigator.mediaDevices ä¸å¯ç”¨');
        //   return;
        // }

        setCameraStatus('pending', 'æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™');
        scanButton.textContent = 'åœæ­¢è¯†åˆ«';
        isScanning = true;

        try {
          console.log('ğŸ” æ­£åœ¨åˆ—ä¸¾æ‘„åƒå¤´è®¾å¤‡...');
          
          // ä½¿ç”¨å®ä¾‹æ–¹æ³•è€Œéé™æ€æ–¹æ³•
          let devices;
          if (typeof codeReader.listVideoInputDevices === 'function') {
            devices = await codeReader.listVideoInputDevices();
          } else if (typeof ZXing.BrowserQRCodeReader.listVideoInputDevices === 'function') {
            devices = await ZXing.BrowserQRCodeReader.listVideoInputDevices();
          } else {
            // å¦‚æœéƒ½ä¸è¡Œï¼Œç›´æ¥è°ƒç”¨æµè§ˆå™¨ API
            const mediaDevices = await navigator.mediaDevices.enumerateDevices();
            devices = mediaDevices.filter(device => device.kind === 'videoinput');
          }
          
          console.log('ğŸ“¹ æ‰¾åˆ°è®¾å¤‡:', devices);
          
          if (!devices || !devices.length) {
            throw new Error('æœªæ£€æµ‹åˆ°å¯ç”¨æ‘„åƒå¤´');
          }
          const selectedDeviceId = chooseBestCamera(devices);
          console.log('âœ… é€‰ä¸­è®¾å¤‡ID:', selectedDeviceId);
          
          codeReader.decodeFromVideoDevice(selectedDeviceId, 'preview', (result, error, controls) => {
            if (controls && !activeControls) {
              activeControls = controls;
              console.log('ğŸ¬ æ‘„åƒå¤´æµå·²å¯åŠ¨');
            }

            if (result) {
              console.log('ğŸ¯ è¯†åˆ«åˆ°äºŒç»´ç :', result.getText());
              handleDecodedText(result.getText());
            }

            if (error && !(error instanceof ZXing.NotFoundException)) {
              console.error('âš ï¸ è¯†åˆ«é”™è¯¯:', error);
              setCameraStatus('error', error.message || 'è¯†åˆ«è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜');
            }
          });
          setCameraStatus('scanning', 'æ‘„åƒå¤´å·²å¯åŠ¨ï¼Œè¯·æŠŠäºŒç»´ç æ”¾å…¥å–æ™¯æ¡†');
        } catch (error) {
          console.error('âŒ æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥:', error);
          const msg = error.message || 'æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥';
          setCameraStatus('error', msg);
          alert('æ‘„åƒå¤´é”™è¯¯:\n' + msg + '\n\nè¯·æ£€æŸ¥:\n1. æ˜¯å¦æˆäºˆæ‘„åƒå¤´æƒé™\n2. æ˜¯å¦ä½¿ç”¨ HTTPS è®¿é—®\n3. æ‘„åƒå¤´æ˜¯å¦è¢«å…¶ä»–åº”ç”¨å ç”¨');
          stopScanning(true);
        }
      }

      function stopScanning(manual = false) {
        if (activeControls) {
          activeControls.stop();
          activeControls = null;
        }
        isScanning = false;
        scanButton.textContent = 'å¼€å§‹è¯†åˆ«';
        if (manual) {
          setCameraStatus('idle', 'æ‘„åƒå¤´å¾…å‘½');
        }
      }

      function handleDecodedText(text) {
        if (!text || text === lastResult) {
          return;
        }
        updateResultDisplay(text, true);
        setCameraStatus('success', 'è¯†åˆ«æˆåŠŸï¼Œå¦‚éœ€ç»§ç»­è¯·å†æ¬¡ç‚¹å‡»');
        stopScanning();
      }

      function updateResultDisplay(text, shouldBroadcast = false, source = 'local') {
        if (!text) {
          lastResult = '';
          resultBox.textContent = 'æš‚æœªè¯†åˆ«å†…å®¹';
          resultBox.dataset.state = 'empty';
          copyButton.disabled = true;
          return;
        }
        lastResult = text;
        resultBox.textContent = text;
        resultBox.dataset.state = 'filled';
        copyButton.disabled = false;

        if (shouldBroadcast) {
          publishResult(text);
        }

        if (source === 'remote') {
          resultBox.classList.add('remote-update');
          setTimeout(() => resultBox.classList.remove('remote-update'), 700);
        }
      }

      function chooseBestCamera(devices) {
        // å…¼å®¹ä¸åŒçš„è®¾å¤‡å¯¹è±¡æ ¼å¼
        const backFacing = devices.find((device) => {
          const label = device.label || '';
          const deviceId = device.deviceId || device.id || '';
          return /back|rear|environment|åç½®/i.test(label) || /back|rear/i.test(deviceId);
        });
        return (backFacing || devices[0]).deviceId || (backFacing || devices[0]).id;
      }

      function handleCopyResult() {
        if (!lastResult) {
          return;
        }
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(lastResult).then(
            () => showCopyFeedback('å·²å¤åˆ¶'),
            () => fallbackCopy()
          );
        } else {
          fallbackCopy();
        }
      }

      function fallbackCopy() {
        if (!lastResult) {
          return;
        }
        const textarea = document.createElement('textarea');
        textarea.value = lastResult;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        let success = false;
        try {
          success = document.execCommand('copy');
        } catch (error) {
          success = false;
        }
        document.body.removeChild(textarea);
        showCopyFeedback(success ? 'å·²å¤åˆ¶' : 'å¤åˆ¶å¤±è´¥');
      }

      function showCopyFeedback(message) {
        const originalLabel = copyButton.dataset.originalLabel || copyButton.textContent;
        if (!copyButton.dataset.originalLabel) {
          copyButton.dataset.originalLabel = originalLabel;
        }
        copyButton.textContent = message;
        copyButton.classList.add('copied');
        clearTimeout(copyResetTimer);
        copyResetTimer = setTimeout(() => {
          copyButton.textContent = copyButton.dataset.originalLabel;
          copyButton.classList.remove('copied');
          copyResetTimer = null;
        }, 1500);
      }

      function initRealtimeSync() {
        if (!window.PubNub) {
          setSyncStatus('error', 'PubNub SDK åŠ è½½å¤±è´¥ï¼Œæ— æ³•å®æ—¶åŒæ­¥');
          return null;
        }
        setSyncStatus('connecting', 'æ­£åœ¨å»ºç«‹åŒæ­¥è¿æ¥');
        const client = new PubNub({
          publishKey: 'demo',
          subscribeKey: 'demo',
          uuid: `qrcode-${Date.now()}-${Math.floor(Math.random() * 10000)}`
        });

        client.addListener({
          status(event) {
            if (event.category === 'PNConnectedCategory' || event.category === 'PNNetworkUpCategory') {
              setSyncStatus('online', 'åŒæ­¥å·²è¿æ¥');
            }
            if (event.category === 'PNNetworkDownCategory' || event.category === 'PNTimeoutCategory') {
              setSyncStatus('error', 'åŒæ­¥ä¸­æ–­ï¼Œæ­£åœ¨è‡ªåŠ¨é‡è¯•');
            }
          },
          message(event) {
            const payload = event.message || {};
            if (!payload.text || payload.sender === client.getUUID()) {
              return;
            }
            updateResultDisplay(payload.text, false, 'remote');
            flashSyncUpdate();
          }
        });

        client.subscribe({ channels: [CHANNEL_NAME] });
        return client;
      }

      function publishResult(text) {
        if (!pubnubClient) {
          return;
        }
        pubnubClient.publish(
          {
            channel: CHANNEL_NAME,
            message: {
              text,
              sender: pubnubClient.getUUID(),
              timestamp: Date.now()
            }
          },
          (status) => {
            if (status.error) {
              console.error(status.errorData || status);
              setSyncStatus('error', 'åŒæ­¥å¤±è´¥ï¼Œç¨åè‡ªåŠ¨é‡è¯•');
            } else {
              setSyncStatus('online', 'ç»“æœå·²åŒæ­¥åˆ°å…¶ä»–ç«¯');
            }
          }
        );
      }

      function flashSyncUpdate() {
        syncStatusDot.style.background = syncColorMap.update;
        syncStatusText.textContent = 'æ”¶åˆ°æ¥è‡ªå¦ä¸€ç«¯çš„ç»“æœ';
        setTimeout(() => setSyncStatus('online', 'åŒæ­¥å·²è¿æ¥'), 2000);
      }

      setCameraStatus('idle', 'æ‘„åƒå¤´å¾…å‘½');
      updateResultDisplay('');
    })();
    }
  </script>
</body>
</html>


